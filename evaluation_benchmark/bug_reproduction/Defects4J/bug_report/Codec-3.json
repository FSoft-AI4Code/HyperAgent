{"issue_id": "CODEC-84", "title": "Double Metaphone bugs in alternative encoding", "description": "\n<div class=\"user-content-block\">\n<p>The new test case (<a class=\"issue-link\" data-issue-key=\"CODEC-83\" href=\"https://issues.apache.org/jira/browse/CODEC-83\" title=\"Improve Double Metaphone test coverage\"><del>CODEC-83</del></a>) has highlighted a number of issues with the \"alternative\" encoding in the Double Metaphone implementation</p>\n<p>1) Bug in the handleG method when \"G\" is followed by \"IER\" </p>\n<ul>\n<li>The alternative encoding of \"Angier\" results in \"ANKR\" rather than \"ANJR\"</li>\n<li>The alternative encoding of \"rogier\" results in \"RKR\" rather than \"RJR\"</li>\n</ul>\n<p>The problem is in the handleG() method and is caused by the wrong length (4 instead of 3) being used in the contains() method:</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\"> } <span class=\"code-keyword\">else</span> <span class=\"code-keyword\">if</span> (contains(value, index + 1, 4, <span class=\"code-quote\">\"IER\"</span>)) {\n</pre>\n</div></div>\n<p>...this should be</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\"> } <span class=\"code-keyword\">else</span> <span class=\"code-keyword\">if</span> (contains(value, index + 1, 3, <span class=\"code-quote\">\"IER\"</span>)) {\n</pre>\n</div></div>\n<p>2)  Bug in the handleL method</p>\n<ul>\n<li>The alternative encoding of \"cabrillo\" results in \"KPRL \" rather than \"KPR\"</li>\n</ul>\n<p>The problem is that the first thing this method does is append an \"L\" to both primary &amp; alternative encoding. When the conditionL0() method returns true then the \"L\" should not be appended for the alternative encoding</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">result.append(<span class=\"code-quote\">'L'</span>);\n<span class=\"code-keyword\">if</span> (charAt(value, index + 1) == <span class=\"code-quote\">'L'</span>) {\n    <span class=\"code-keyword\">if</span> (conditionL0(value, index)) {\n        result.appendAlternate(<span class=\"code-quote\">' '</span>);\n    }\n    index += 2;\n} <span class=\"code-keyword\">else</span> {\n    index++;\n}\n<span class=\"code-keyword\">return</span> index;\n</pre>\n</div></div>\n<p>Suggest refeactoring this to</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\"><span class=\"code-keyword\">if</span> (charAt(value, index + 1) == <span class=\"code-quote\">'L'</span>) {\n    <span class=\"code-keyword\">if</span> (conditionL0(value, index)) {\n        result.appendPrimary(<span class=\"code-quote\">'L'</span>);\n    } <span class=\"code-keyword\">else</span> {\n        result.append(<span class=\"code-quote\">'L'</span>);\n    }\n    index += 2;\n} <span class=\"code-keyword\">else</span> {\n    result.append(<span class=\"code-quote\">'L'</span>);\n    index++;\n}\n<span class=\"code-keyword\">return</span> index;\n</pre>\n</div></div>\n<p>3) Bug in the conditionL0() method for words ending in \"AS\" and \"OS\"</p>\n<ul>\n<li>The alternative encoding of \"gallegos\" results in \"KLKS\" rather than \"KKS\"</li>\n</ul>\n<p>The problem is caused by the wrong start position being used in the contains() method, which means its not checking the last two characters of the word but checks the previous &amp; current position instead:</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">        } <span class=\"code-keyword\">else</span> <span class=\"code-keyword\">if</span> ((contains(value, index - 1, 2, <span class=\"code-quote\">\"AS\"</span>, <span class=\"code-quote\">\"OS\"</span>) || \n</pre>\n</div></div>\n<p>...this should be</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">        } <span class=\"code-keyword\">else</span> <span class=\"code-keyword\">if</span> ((contains(value, value.length() - 2, 2, <span class=\"code-quote\">\"AS\"</span>, <span class=\"code-quote\">\"OS\"</span>) || \n</pre>\n</div></div>\n<p>I'll attach a patch for review</p>\n</div>\n"}