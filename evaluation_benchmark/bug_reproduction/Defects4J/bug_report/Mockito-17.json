{"issue_id": "152", "title": "Mockito 1.10.x timeout verification needs JUnit classes (VerifyError, NoClassDefFoundError)", "description": "\n<p dir=\"auto\">If JUnit is not on the classpath and mockito is version 1.10.x (as of now 1.10.1 up to 1.10.19) and the code is using the timeout verification which is not supposed to be related to JUnit, then the JVM may fail with a <code class=\"notranslate\">VerifyError</code> or a <code class=\"notranslate\">NoClassDefFoundError</code>.</p>\n<p dir=\"auto\">This issue has been reported on the <a href=\"https://groups.google.com/forum/#!topic/mockito/A6D7myKiD5k\" rel=\"nofollow\">mailing list</a> and on <a href=\"http://stackoverflow.com/questions/27721621/java-lang-verifyerror-with-mockito-1-10-17\" rel=\"nofollow\">StackOverflow</a></p>\n<p dir=\"auto\">A simple test like that with <strong>TestNG</strong> (and no JUnit in the class path of course) exposes the issue:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"import org.testng.annotations.Test;\nimport java.util.Observable;\nimport static org.mockito.Mockito.*;\n\npublic class VerifyErrorOnVerificationWithTimeoutTest {\n    @Test public void should_not_throw_VerifyError() {\n        verify(mock(Observable.class), timeout(500)).countObservers();\n    }\n}\"><pre class=\"notranslate\"><code>import org.testng.annotations.Test;\nimport java.util.Observable;\nimport static org.mockito.Mockito.*;\n\npublic class VerifyErrorOnVerificationWithTimeoutTest {\n    @Test public void should_not_throw_VerifyError() {\n        verify(mock(Observable.class), timeout(500)).countObservers();\n    }\n}\n</code></pre></div>\n<p dir=\"auto\">With TestNG 5.13.1, the stack trace is :</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.VerifyError: (class: org/mockito/internal/verification/VerificationOverTimeImpl, method: verify signature: (Lorg/mockito/internal/verification/api/VerificationData;)V) Incompatible argument to function\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:32)\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:25)\n    at org.mockito.Mockito.timeout(Mockito.java:2103)\n    at com.example.UserServiceImplTest.test(UserServiceImplTest.java:26)\"><pre class=\"notranslate\"><code>java.lang.VerifyError: (class: org/mockito/internal/verification/VerificationOverTimeImpl, method: verify signature: (Lorg/mockito/internal/verification/api/VerificationData;)V) Incompatible argument to function\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:32)\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:25)\n    at org.mockito.Mockito.timeout(Mockito.java:2103)\n    at com.example.UserServiceImplTest.test(UserServiceImplTest.java:26)\n</code></pre></div>\n<p dir=\"auto\">TestNG includes a dependency on JUnit 3.8.1, which has the <code class=\"notranslate\">junit.framework.ComparisonFailure</code>, but the JVM cannot perform the linking at runtime (<code class=\"notranslate\">VerifyError</code> extends <code class=\"notranslate\">LinkageError</code>), probably because for the JVM there's some incompatible changes in this class between version 3.x and 4.x.<br/>\nNote that Mockito is compiled against JUnit 4.x. This also reveal that Mockito is not anymore compatible with JUnit 3.x.</p>\n<p dir=\"auto\">With TestNG 6.8.13, the stack trace is :</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.NoClassDefFoundError: junit/framework/ComparisonFailure\n    at java.lang.ClassLoader.defineClass1(Native Method)\n    at java.lang.ClassLoader.defineClassCond(ClassLoader.java:637)\n    at java.lang.ClassLoader.defineClass(ClassLoader.java:621)\n    at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:141)\n    at java.net.URLClassLoader.defineClass(URLClassLoader.java:283)\n    at java.net.URLClassLoader.access$000(URLClassLoader.java:58)\n    at java.net.URLClassLoader$1.run(URLClassLoader.java:197)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:190)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:247)\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:32)\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:25)\n    at org.mockito.Mockito.timeout(Mockito.java:2103)\n    at com.example.UserServiceImplTest.test(UserServiceImplTest.java:26)\nCaused by: java.lang.ClassNotFoundException: junit.framework.ComparisonFailure\n    at java.net.URLClassLoader$1.run(URLClassLoader.java:202)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:190)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:247)\n    ... 49 more\"><pre class=\"notranslate\"><code>java.lang.NoClassDefFoundError: junit/framework/ComparisonFailure\n    at java.lang.ClassLoader.defineClass1(Native Method)\n    at java.lang.ClassLoader.defineClassCond(ClassLoader.java:637)\n    at java.lang.ClassLoader.defineClass(ClassLoader.java:621)\n    at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:141)\n    at java.net.URLClassLoader.defineClass(URLClassLoader.java:283)\n    at java.net.URLClassLoader.access$000(URLClassLoader.java:58)\n    at java.net.URLClassLoader$1.run(URLClassLoader.java:197)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:190)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:247)\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:32)\n    at org.mockito.verification.Timeout.&lt;init&gt;(Timeout.java:25)\n    at org.mockito.Mockito.timeout(Mockito.java:2103)\n    at com.example.UserServiceImplTest.test(UserServiceImplTest.java:26)\nCaused by: java.lang.ClassNotFoundException: junit.framework.ComparisonFailure\n    at java.net.URLClassLoader$1.run(URLClassLoader.java:202)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:190)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:247)\n    ... 49 more\n</code></pre></div>\n<p dir=\"auto\">Indeed JUnit is not anymore a dependency of TestNG.</p>\n<p dir=\"auto\">In this specific case the issue is that the <code class=\"notranslate\">Timeout</code> class wraps a <code class=\"notranslate\">VerficationOverTimeImpl</code> that uses in try/catch block the exception <code class=\"notranslate\">org.mockito.exceptions.verification.junit.ArgumentsAreDifferent</code> which extends <code class=\"notranslate\">junit.framework.ComparisonFailure</code>.</p>\n<p dir=\"auto\">At this time it seems to be the only place where JUnit is needed, this affect the following public API :</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Mockito.timeout(...)\nMockito.after(...)\"><pre><span class=\"pl-s1\">Mockito</span>.<span class=\"pl-en\">timeout</span>(...)\n<span class=\"pl-s1\">Mockito</span>.<span class=\"pl-en\">after</span>(...)</pre></div>\n"}