{"issue_id": "LANG-882", "title": "LookupTranslator accepts CharSequence as input, but fails to work with implementations other than String", "description": "\n<div class=\"user-content-block\">\n<p>The core of <tt>org.apache.commons.lang3.text.translate</tt> is a <tt>HashMap&lt;CharSequence, CharSequence&gt; lookupMap</tt>.</p>\n<p>From the Javadoc of <tt>CharSequence</tt> (emphasis mine):</p>\n<blockquote>\n<p>This interface does not refine the general contracts of the equals and hashCode methods. The result of comparing two objects that implement CharSequence is therefore, in general, undefined. Each object may be implemented by a different class, and there is no guarantee that each class will be capable of testing its instances for equality with those of the other. <b>It is therefore inappropriate to use arbitrary CharSequence instances as elements in a set or as keys in a map.</b></p></blockquote>\n<p>The current implementation causes code such as the following to not work as expected:</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">CharSequence cs1 = <span class=\"code-quote\">\"1 &lt; 2\"</span>;\nCharSequence cs2 = CharBuffer.wrap(<span class=\"code-quote\">\"1 &lt; 2\"</span>.toCharArray());\n\n<span class=\"code-object\">System</span>.out.println(StringEscapeUtils.ESCAPE_HTML4.translate(cs1));\n<span class=\"code-object\">System</span>.out.println(StringEscapeUtils.ESCAPE_HTML4.translate(cs2));\n</pre>\n</div></div>\n<p>... which gives the following results (but should be identical):</p>\n<div class=\"preformatted panel\" style=\"border-width: 1px;\"><div class=\"preformattedContent panelContent\">\n<pre>1 &amp;lt; 2\n1 &lt; 2\n</pre>\n</div></div>\n<p>The problem, at a minimum, is that <tt>CharBuffer.equals</tt> is even documented in the Javadoc that:</p>\n<blockquote>\n<p>A char buffer is not equal to any other type of object.</p></blockquote>\n<p>... so a lookup on a CharBuffer in the Map will always fail when compared against the String implementations that it contains.</p>\n<p>An obvious work-around is to instead use something along the lines of either of the following:</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\"><span class=\"code-object\">System</span>.out.println(StringEscapeUtils.ESCAPE_HTML4.translate(cs2.toString()));\n<span class=\"code-object\">System</span>.out.println(StringEscapeUtils.escapeHtml4(cs2.toString()));\n</pre>\n</div></div>\n<p>... which forces everything back to a <tt>String</tt>.  However, this is not practical when working with large sets of data, which would require significant heap allocations and garbage collection concerns.  (As such, I was actually trying to use the <tt>translate</tt> method that outputs to a <tt>Writer</tt> - but simplified the above examples to omit this.)</p>\n<p>Another option that I'm considering is to use a custom <tt>CharSequence</tt> wrapper around a <tt>char[]</tt> that implements <tt>hashCode()</tt> and <tt>equals()</tt> to work with those implemented on <tt>String</tt>.  (However, this will be interesting due to the symmetric assumption - which is further interesting that <tt>String.equals</tt> is currently implemented using <tt>instanceof</tt> - even though <tt>String</tt> is <tt>final</tt>...)</p>\n</div>\n"}