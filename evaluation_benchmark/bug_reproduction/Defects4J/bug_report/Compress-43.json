{"issue_id": "COMPRESS-394", "title": "[Zip] Local `Version Needed To Extract` does not match Central Directory", "description": "\n<div class=\"user-content-block\">\n<p>Hi,</p>\n<p>This is followup on an issue reported on Plexus Archiver - <a class=\"external-link\" href=\"https://github.com/codehaus-plexus/plexus-archiver/issues/57\" rel=\"nofollow noopener\" target=\"_blank\">https://github.com/codehaus-plexus/plexus-archiver/issues/57</a></p>\n<p>Plexus Archiver uses <tt>ZipArchiveOutputStream</tt> to create zip archives. It constructs the <tt>ZipArchiveOutputStream</tt> using <tt>BufferedOutputStream</tt>. As a result the output do not provide random access and additional data descriptor records are added. Unfortunately this leads to different values being set for <tt>version needed to extract</tt> field in the local file header and in the central directory. It looks like that the root cause is the way the local header <tt>version needed to extract</tt> field value is calculated:</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">        <span class=\"code-keyword\">if</span> (phased &amp;&amp;  !isZip64Required(entry.entry, zip64Mode)){\n            putShort(INITIAL_VERSION, buf, LFH_VERSION_NEEDED_OFFSET);\n        } <span class=\"code-keyword\">else</span> {\n            putShort(versionNeededToExtract(zipMethod, hasZip64Extra(ze)), buf, LFH_VERSION_NEEDED_OFFSET);\n        }\n</pre>\n</div></div>\n<p>As you can see the need for data descriptors is not taken into account. On other hand when the central directory is created the following is used to determine the minimum required version</p>\n<div class=\"code panel\" style=\"border-width: 1px;\"><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">    <span class=\"code-keyword\">private</span> <span class=\"code-object\">int</span> versionNeededToExtract(<span class=\"code-keyword\">final</span> <span class=\"code-object\">int</span> zipMethod, <span class=\"code-keyword\">final</span> <span class=\"code-object\">boolean</span> zip64) {\n        <span class=\"code-keyword\">if</span> (zip64) {\n            <span class=\"code-keyword\">return</span> ZIP64_MIN_VERSION;\n        }\n        <span class=\"code-comment\">// requires version 2 as we are going to store length info\n</span>        <span class=\"code-comment\">// in the data descriptor\n</span>        <span class=\"code-keyword\">return</span> (isDeflatedToOutputStream(zipMethod)) ?\n                DATA_DESCRIPTOR_MIN_VERSION :\n                INITIAL_VERSION;\n    }\n</pre>\n</div></div>\n<p>As a side note: I'm not a zip expert by any means so I could be wrong, but my understanding is that if Deflate compression is used then the minimum required version should be 2.0 regardless if data descriptors are used or not.</p>\n</div>\n"}