{"issue_id": "LANG-477", "title": "ExtendedMessageFormat: OutOfMemory with custom format registry and a pattern containing single quotes", "description": "\n<div class=\"user-content-block\">\n<p>When using ExtendedMessageFormat with a custom format registry and a pattern conatining single quotes, an OutOfMemoryError will occur.</p>\n<p>Example that will cause error:</p>\n<div class=\"code panel\" style=\"border-style: solid;border-width: 1px;\"><div class=\"codeHeader panelHeader\" style=\"border-bottom-width: 1px;border-bottom-style: solid;\"><b>ExtendedMessageFormatTest.java</b></div><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">\n<span class=\"code-keyword\">private</span> <span class=\"code-keyword\">static</span> Map&lt;<span class=\"code-object\">String</span>, <span class=\"code-object\">Object</span>&gt; formatRegistry = <span class=\"code-keyword\">new</span> HashMap&lt;<span class=\"code-object\">String</span>, <span class=\"code-object\">Object</span>&gt;();    \n    <span class=\"code-keyword\">static</span> {\n        formatRegistry.put(DummyFormatFactory.DUMMY_FORMAT, <span class=\"code-keyword\">new</span> DummyFormatFactory());\n    }\n    \n    <span class=\"code-keyword\">public</span> <span class=\"code-keyword\">static</span> void main(<span class=\"code-object\">String</span>[] args) {\n        ExtendedMessageFormat mf = <span class=\"code-keyword\">new</span> ExtendedMessageFormat(<span class=\"code-quote\">\"it<span class=\"code-quote\">''s a {dummy} '</span>test'!\"</span>, formatRegistry);\n        <span class=\"code-object\">String</span> formattedPattern = mf.format(<span class=\"code-keyword\">new</span> <span class=\"code-object\">String</span>[] {<span class=\"code-quote\">\"great\"</span>});\n        <span class=\"code-object\">System</span>.out.println(formattedPattern);\n    }\n}\n\n</pre>\n</div></div>\n<p>The following change starting at line 421 on the 2.4 release seems to fix the problem:</p>\n<div class=\"code panel\" style=\"border-style: solid;border-width: 1px;\"><div class=\"codeHeader panelHeader\" style=\"border-bottom-width: 1px;border-bottom-style: solid;\"><b>ExtendedMessageFormat.java</b></div><div class=\"codeContent panelContent\">\n<pre class=\"code-java\">CURRENT (Broken):\n<span class=\"code-keyword\">if</span> (escapingOn &amp;&amp; c[start] == QUOTE) {\n        <span class=\"code-keyword\">return</span> appendTo == <span class=\"code-keyword\">null</span> ? <span class=\"code-keyword\">null</span> : appendTo.append(QUOTE);\n}\n\nWORKING:\n<span class=\"code-keyword\">if</span> (escapingOn &amp;&amp; c[start] == QUOTE) {\n        next(pos);\n        <span class=\"code-keyword\">return</span> appendTo == <span class=\"code-keyword\">null</span> ? <span class=\"code-keyword\">null</span> : appendTo.append(QUOTE);\n}\n</pre>\n</div></div>\n</div>\n"}