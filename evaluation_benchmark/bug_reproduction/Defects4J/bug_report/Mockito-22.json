{"issue_id": "484", "title": "Can not Return deep stubs from generic method that returns generic type", "description": "\n<p dir=\"auto\">Hey,</p>\n<p dir=\"auto\">if I try to mock a generic method which a generic returntype, where the returntype is derived from the generic type of the method using deep stubs I get a <code class=\"notranslate\">ClassCastException</code> when calling <code class=\"notranslate\">when</code> on it.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"interface I {\n    &lt;T&gt; Supplier&lt;T&gt; m(Class&lt;T&gt; type);\n}\n@Test\npublic void test() throws Exception {\n    I i = mock(I.class, RETURNS_DEEP_STUBS);\n    when(i.m(Boolean.class).get()); // &lt;- ClassCastException\n}\"><pre class=\"notranslate\"><code>interface I {\n    &lt;T&gt; Supplier&lt;T&gt; m(Class&lt;T&gt; type);\n}\n@Test\npublic void test() throws Exception {\n    I i = mock(I.class, RETURNS_DEEP_STUBS);\n    when(i.m(Boolean.class).get()); // &lt;- ClassCastException\n}\n</code></pre></div>\n<p dir=\"auto\">When you don't use deep stubs and a raw <code class=\"notranslate\">Supplier</code> mock to pass around it works:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"I i = mock(I.class);\nSupplier s = mock(Supplier.class);\nwhen(i.m(Boolean.class)).thenReturn(s);\nwhen(i.m(Boolean.class).get());\"><pre class=\"notranslate\"><code>I i = mock(I.class);\nSupplier s = mock(Supplier.class);\nwhen(i.m(Boolean.class)).thenReturn(s);\nwhen(i.m(Boolean.class).get());\n</code></pre></div>\n<p dir=\"auto\">The <code class=\"notranslate\">ClassCastException</code>:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.ClassCastException: org.mockito.internal.creation.cglib.ClassImposterizer$ClassWithSuperclassToWorkAroundCglibBug$$EnhancerByMockitoWithCGLIB$$cdb13154 cannot be cast to java.lang.String\n  at MockitoGenerics.test(MockitoGenerics.java:21)\n  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n  at java.lang.reflect.Method.invoke(Method.java:483)\n  at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n  at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n  at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n  at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)\n  at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)\n  at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)\n  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)\n  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)\n  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)\n  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)\n  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)\n  at org.junit.runners.ParentRunner.run(ParentRunner.java:309)\n  at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:50)\n  at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:675)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)\"><pre class=\"notranslate\"><code>java.lang.ClassCastException: org.mockito.internal.creation.cglib.ClassImposterizer$ClassWithSuperclassToWorkAroundCglibBug$$EnhancerByMockitoWithCGLIB$$cdb13154 cannot be cast to java.lang.String\n  at MockitoGenerics.test(MockitoGenerics.java:21)\n  at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n  at java.lang.reflect.Method.invoke(Method.java:483)\n  at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n  at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n  at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n  at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)\n  at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)\n  at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)\n  at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)\n  at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)\n  at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)\n  at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)\n  at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)\n  at org.junit.runners.ParentRunner.run(ParentRunner.java:309)\n  at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:50)\n  at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:675)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)\n  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)\n</code></pre></div>\n<p dir=\"auto\">Tested using mockito 1.10.19, jdk 1.8.0_20 and no Powermock</p>\n"}