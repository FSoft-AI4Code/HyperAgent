{"issue_id": "1573", "title": "Missing properties when deserializing using a builder class with a non-default constructor and a mutator annotated with <code>@JsonUnwrapped</code>", "description": "\n<p dir=\"auto\">When deserializing using a builder class with a non-default constructor and any number of mutator methods annotated with @JsonUnwrapped, the <code class=\"notranslate\">BuilderBasedDeserializer::deserializeUsingPropertyBasedWithUnwrapped</code> method cuts short the process of adding SettableBeanProperties.</p>\n<p dir=\"auto\">The logic dictates that once all properties necessary to construct the builder have been found, the builder is constructed using all known SettableBeanProperties that have been found up to that point in the tokenizing process.</p>\n<p dir=\"auto\">Therefore, in the case that the builder has a single property required for construction, and that property is found anywhere other than at the end of the JSON content, any properties subsequent to the constructor property are not evaluated and are left with their default values.</p>\n<p dir=\"auto\">Given the following classes:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content='@JsonDeserialize(builder = Employee.Builder.class)\npublic class Employee {\n    private final long id;\n    private final Name name;\n    private final int age;\n\n    private Employee(Builder builder) {\n        id = builder.id;\n        name = builder.name;\n        age = builder.age;\n    }\n\n    public long getId() {\n        return id;\n    }\n\n    public Name getName() {\n        return name;\n    }\n\n    public int getAge() {\n        return age;\n    }\n\n    @JsonPOJOBuilder(withPrefix = \"set\")\n    public static class Builder {\n        private final long id;\n        private Name name;\n        private int age;\n\n        @JsonCreator\n        public Builder(@JsonProperty(\"emp_id\") long id) {\n            this.id = id;\n        }\n\n        @JsonUnwrapped\n        public void setName(Name name) {\n            this.name = name;\n        }\n\n        @JsonProperty(\"emp_age\")\n        public void setAge(int age) {\n            this.age = age;\n        }\n\n        public Employee build() {\n            return new Employee(this);\n        }\n    }\n}\n\npublic class Name {\n    private final String first;\n    private final String last;\n\n    @JsonCreator\n    public Name(\n        @JsonProperty(\"emp_first_name\") String first,\n        @JsonProperty(\"emp_last_name\") String last\n    ) {\n        this.first = first;\n        this.last = last;\n    }\n\n    public String getFirst() {\n        return first;\n    }\n\n    public String getLast() {\n        return last;\n    }\n}'><pre><span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonDeserialize</span>(<span class=\"pl-s1\">builder</span> = <span class=\"pl-smi\">Employee</span>.<span class=\"pl-s1\">Builder</span>.<span class=\"pl-s1\">class</span>)\n<span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">Employee</span> {\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">long</span> <span class=\"pl-s1\">id</span>;\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">Name</span> <span class=\"pl-s1\">name</span>;\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">int</span> <span class=\"pl-s1\">age</span>;\n\n    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">Employee</span>(<span class=\"pl-smi\">Builder</span> <span class=\"pl-s1\">builder</span>) {\n        <span class=\"pl-s1\">id</span> = <span class=\"pl-s1\">builder</span>.<span class=\"pl-s1\">id</span>;\n        <span class=\"pl-s1\">name</span> = <span class=\"pl-s1\">builder</span>.<span class=\"pl-s1\">name</span>;\n        <span class=\"pl-s1\">age</span> = <span class=\"pl-s1\">builder</span>.<span class=\"pl-s1\">age</span>;\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">long</span> <span class=\"pl-en\">getId</span>() {\n        <span class=\"pl-k\">return</span> <span class=\"pl-s1\">id</span>;\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">Name</span> <span class=\"pl-en\">getName</span>() {\n        <span class=\"pl-k\">return</span> <span class=\"pl-s1\">name</span>;\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">int</span> <span class=\"pl-en\">getAge</span>() {\n        <span class=\"pl-k\">return</span> <span class=\"pl-s1\">age</span>;\n    }\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonPOJOBuilder</span>(<span class=\"pl-s1\">withPrefix</span> = <span class=\"pl-s\">\"set\"</span>)\n    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">Builder</span> {\n        <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">long</span> <span class=\"pl-s1\">id</span>;\n        <span class=\"pl-k\">private</span> <span class=\"pl-smi\">Name</span> <span class=\"pl-s1\">name</span>;\n        <span class=\"pl-k\">private</span> <span class=\"pl-smi\">int</span> <span class=\"pl-s1\">age</span>;\n\n        <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonCreator</span>\n        <span class=\"pl-k\">public</span> <span class=\"pl-smi\">Builder</span>(<span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonProperty</span>(<span class=\"pl-s\">\"emp_id\"</span>) <span class=\"pl-smi\">long</span> <span class=\"pl-s1\">id</span>) {\n            <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">id</span> = <span class=\"pl-s1\">id</span>;\n        }\n\n        <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonUnwrapped</span>\n        <span class=\"pl-k\">public</span> <span class=\"pl-smi\">void</span> <span class=\"pl-en\">setName</span>(<span class=\"pl-smi\">Name</span> <span class=\"pl-s1\">name</span>) {\n            <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">name</span> = <span class=\"pl-s1\">name</span>;\n        }\n\n        <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonProperty</span>(<span class=\"pl-s\">\"emp_age\"</span>)\n        <span class=\"pl-k\">public</span> <span class=\"pl-smi\">void</span> <span class=\"pl-en\">setAge</span>(<span class=\"pl-smi\">int</span> <span class=\"pl-s1\">age</span>) {\n            <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">age</span> = <span class=\"pl-s1\">age</span>;\n        }\n\n        <span class=\"pl-k\">public</span> <span class=\"pl-smi\">Employee</span> <span class=\"pl-en\">build</span>() {\n            <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">Employee</span>(<span class=\"pl-smi\">this</span>);\n        }\n    }\n}\n\n<span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">Name</span> {\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">first</span>;\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">last</span>;\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonCreator</span>\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">Name</span>(\n        <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonProperty</span>(<span class=\"pl-s\">\"emp_first_name\"</span>) <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">first</span>,\n        <span class=\"pl-c1\">@</span><span class=\"pl-c1\">JsonProperty</span>(<span class=\"pl-s\">\"emp_last_name\"</span>) <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">last</span>\n    ) {\n        <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">first</span> = <span class=\"pl-s1\">first</span>;\n        <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">last</span> = <span class=\"pl-s1\">last</span>;\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">String</span> <span class=\"pl-en\">getFirst</span>() {\n        <span class=\"pl-k\">return</span> <span class=\"pl-s1\">first</span>;\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">String</span> <span class=\"pl-en\">getLast</span>() {\n        <span class=\"pl-k\">return</span> <span class=\"pl-s1\">last</span>;\n    }\n}</pre></div>\n<p dir=\"auto\">And given the following JSON string:</p>\n<div class=\"highlight highlight-source-json notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content='{\n    \"emp_age\": 30,\n    \"emp_id\": 1234,\n    \"emp_first_name\": \"John\",\n    \"emp_last_name\": \"Doe\"\n}'><pre>{\n    <span class=\"pl-ent\">\"emp_age\"</span>: <span class=\"pl-c1\">30</span>,\n    <span class=\"pl-ent\">\"emp_id\"</span>: <span class=\"pl-c1\">1234</span>,\n    <span class=\"pl-ent\">\"emp_first_name\"</span>: <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>John<span class=\"pl-pds\">\"</span></span>,\n    <span class=\"pl-ent\">\"emp_last_name\"</span>: <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Doe<span class=\"pl-pds\">\"</span></span>\n}</pre></div>\n<p dir=\"auto\">We will see the following output:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Employee emp = new ObjectMapper().readValue(json, Employee.class);\n\nSystem.out.println(emp.getAge()); // 30\nSystem.out.println(emp.getId()); // 1234\nSystem.out.println(emp.getName()); // null\"><pre><span class=\"pl-smi\">Employee</span> <span class=\"pl-s1\">emp</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ObjectMapper</span>().<span class=\"pl-en\">readValue</span>(<span class=\"pl-s1\">json</span>, <span class=\"pl-smi\">Employee</span>.<span class=\"pl-s1\">class</span>);\n\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getAge</span>()); <span class=\"pl-c\">// 30</span>\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getId</span>()); <span class=\"pl-c\">// 1234</span>\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getName</span>()); <span class=\"pl-c\">// null</span></pre></div>\n<p dir=\"auto\">However, if we place the <code class=\"notranslate\">emp_id</code> property at the end of the JSON string, we would get the following output:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Employee emp = new ObjectMapper().readValue(json, Employee.class);\n\nSystem.out.println(emp.getAge()); // 30\nSystem.out.println(emp.getId()); // 1234\nSystem.out.println(emp.getName()); // Name Object\"><pre><span class=\"pl-smi\">Employee</span> <span class=\"pl-s1\">emp</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ObjectMapper</span>().<span class=\"pl-en\">readValue</span>(<span class=\"pl-s1\">json</span>, <span class=\"pl-smi\">Employee</span>.<span class=\"pl-s1\">class</span>);\n\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getAge</span>()); <span class=\"pl-c\">// 30</span>\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getId</span>()); <span class=\"pl-c\">// 1234</span>\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getName</span>()); <span class=\"pl-c\">// Name Object</span></pre></div>\n<p dir=\"auto\">If we were to place <code class=\"notranslate\">emp_age</code> and <code class=\"notranslate\">emp_first_name</code> and <code class=\"notranslate\">emp_last_name</code> all after the <code class=\"notranslate\">emp_id</code> property in the JSON string, we would get the following output:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Employee emp = new ObjectMapper().readValue(json, Employee.class);\n\nSystem.out.println(emp.getAge()); // 0\nSystem.out.println(emp.getId()); // 1234\nSystem.out.println(emp.getName()); // null\"><pre><span class=\"pl-smi\">Employee</span> <span class=\"pl-s1\">emp</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ObjectMapper</span>().<span class=\"pl-en\">readValue</span>(<span class=\"pl-s1\">json</span>, <span class=\"pl-smi\">Employee</span>.<span class=\"pl-s1\">class</span>);\n\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getAge</span>()); <span class=\"pl-c\">// 0</span>\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getId</span>()); <span class=\"pl-c\">// 1234</span>\n<span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s1\">emp</span>.<span class=\"pl-en\">getName</span>()); <span class=\"pl-c\">// null</span></pre></div>\n"}